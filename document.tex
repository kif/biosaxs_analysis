%------------------------------------------------------------------------------
% Template file for the submission of papers to IUCr journals in LaTeX2e
% using the iucr document class
% Copyright 1999-2013 International Union of Crystallography
% Version 1.6 (28 March 2013)
%------------------------------------------------------------------------------

\documentclass[preprint]{iucr}              % DO NOT DELETE THIS LINE

     %-------------------------------------------------------------------------
     % Information about journal to which submitted
     %-------------------------------------------------------------------------
     \journalcode{S}              % Indicate the journal to which submitted
                                  %   A - Acta Crystallographica Section A
                                  %   B - Acta Crystallographica Section B
                                  %   C - Acta Crystallographica Section C
                                  %   D - Acta Crystallographica Section D
                                  %   E - Acta Crystallographica Section E
                                  %   F - Acta Crystallographica Section F
                                  %   J - Journal of Applied Crystallography
                                  %   M - IUCrJ
                                  %   S - Journal of Synchrotron Radiation

\begin{document}                  % DO NOT DELETE THIS LINE

     %-------------------------------------------------------------------------
     % The introductory (header) part of the paper
     %-------------------------------------------------------------------------

     % The title of the paper. Use \shorttitle to indicate an abbreviated title
     % for use in running heads (you will need to uncomment it).

\title{Title of Paper}
%\shorttitle{Short Title}

     % Authors' names and addresses. Use \cauthor for the main (contact) author.
     % Use \author for all other authors. Use \aff for authors' affiliations.
     % Use lower-case letters in square brackets to link authors to their
     % affiliations; if there is only one affiliation address, remove the [a].

\cauthor[a]{Forename}{Surname}{email}{address if different from \aff}
\author[b]{Forename}{Surname}

\aff[a]{First affiliation address \country{France}}
\aff[b]{Second affiliation address}

Jerome
Martha
Jesse
Guillaume
Alex
Mark
Petra

     % Use \shortauthor to indicate an abbreviated author list for use in
     % running heads (you will need to uncomment it).

%\shortauthor{Soape, Author and Doe}

     % Use \vita if required to give biographical details (for authors of
     % invited review papers only). Uncomment it.

%\vita{Author's biography}

     % Keywords (required for Journal of Synchrotron Radiation only)
     % Use the \keyword macro for each word or phrase, e.g. 
     % \keyword{X-ray diffraction}\keyword{muscle}

%\keyword{keyword}

     % PDB and NDB reference codes for structures referenced in the article and
     % deposited with the Protein Data Bank and Nucleic Acids Database (Acta
     % Crystallographica Section D). Repeat for each separate structure e.g
     % \PDBref[dethiobiotin synthetase]{1byi} \NDBref[d(G$_4$CGC$_4$)]{ad0002}

%\PDBref[optional name]{refcode}
%\NDBref[optional name]{refcode}

\maketitle                        % DO NOT DELETE THIS LINE

\begin{synopsis}
Detailed presentation of the automatic data analysis pipeline for the BioSAXS beam-line at the European synchrotron.  
\end{synopsis}

\begin{abstract}
Abstract goes here.
\end{abstract}


     %-------------------------------------------------------------------------
     % The main body of the paper
     %-------------------------------------------------------------------------
     % Now enter the text of the document in multiple \section's, \subsection's
     % and \subsubsection's as required.

\section{Introduction}
Small angle scattering (SAS) provides low resolution information on macromolecules and it is  
particularly suited for biological sample thanks to the absence of lengthy preparation. 
Biologists expects from SAXS experiment to retrieve the size and the shape of their protein or complex under study.
Automated analysis is hence of crucial importance for them.

The BioSAXS\cite{BM29paper} beamline had an automated pipeline for the data-analysis which was based on EDNA\cite{EDNA} and the ATSAS\cite{ATSAS}
software. 
While the outcome of the processing was very appreciated by our users, the system was already close to the maximal throughput possible in terms of performances. 
With the increase of brilliance expected from the EBS\cite{EBS} and the refurbishment of the complete beamline which took place during the associated shutdown, 
a complete rewrite of all the analysis code was considered.

This contribution is divided in two main parts, starting with presentation of the tools used for 
processing SAS data (\textit{FreeSAS}) and for assembling pipelines (\textit{Dahu}).
Then the different pipelines are presented, the common for the reduction of the scattering images and two dedicated for sample-changer and SEC-SAXS experiments.      

\section{Tools}

To reach the 10-fold speed up expected from the new EBS source and the new detector (Upgrade from a Pilatus 1M to a 2M with a thick sensor, mounted \textit{in vacuum})
all software used at the beamline was upgraded.
Precise benchmarking of the execution times of the previous EDNA-based pipeline demonstated that 
most time was spent in launching external tools coming from the ATSAS suite and in parsing text files produced by those tools.
It was descided to rewrite all pipeline in plain Python \cite{Python} and call SAS-related tasks from a library, \textit{FreeSAS}. 
Finally the interface to the control software, Bliss \cite{bliss}, would go via Tango \cite{tango} and use a simple FIFO task scheduler,  \textit{dahu}, 
already used in production on another SAXS beamline at the ESRF: ID02\cite{ID02}.   

\subsection{The SAS processing tools, \textit{FreeSAS}}

\textit{FreeSAS} is a Python\cite{python} library containing SAS analysis tools available both via command like interface and from the Python API. 
It does not claim to be as complete as the ATSAS counterpart,
but is free, released under the MIT license (i.e. it can be included in commercial products), all source code is available publicly on github \cite{freesas} and
open to contributions.
Despite Python being an interpreted language, FreeSAS is performance oriented and most of the processing is performed in Cython\cite{cython} extensions written in C 
to obtain the seeked performances. 
All the code has been made available and packaged independently from the online analysis tools to offer ESRF users and other scientists
the ability to reprocess their data and compare the processing between software and institutes.

\subsubsection{SAS plotting}

TODO: insert an image  of the tool
Note:
$q = 4\pi sin(2\theta/2)$

\subsubsection{Guinier region fitting}
Guinier analysis \cite{guinier} is usually the first analysis performed in BioSAXS to determine the radius of gyration ($R_g$)of the macromolecule (and the forwards scattering value $I_0$.
$R_g$ is obtained from the slope of a linear regression of $ln(I)$ as function of $q^2$ on the proper q-range where this curve is afine (the Guinier-range).
The selection of the Guinier-range is far from being obvious since most of subsequent analysis depend on the proper assesement of this regions, 
multiple implementation are provided: \textit{autorg.py} which derives from the BioXTAS-RAW\cite{BioXTAS}, \textit{auto_guinier.py} which differs from the BioXTAS-RAW
one by searching for a consensus region rather than the best region. 
\textit{auto_gpa.py} performs a Guinier-peak-analysis\cite{gpa}, which is a quick assessment of the $R_g$ and $I_0$ and sometimes less robust than the two other implementations. 

It is worth mentionning that none of the three algorithms are provided the exact same results as the AUTORG\cite{ATSAS2} version from ATSAS. 
This highlights the importance of publishing the actual implementation of the algorithms with the associated numerical constants.
  
\subsubsection{Pair distribution function}
Despite the scattering curve ($I(q)$) is the Fourier transform of the pair distribution function $p(r)$, the later cannot directly be obtained from the
inverse Fourier tranform (IFT due to the loss of phase information and the limited amount of information in the scattering curve. 
This ill-posed mathematical has not exact solution and is usually inversed with some extra constraints imposed, like the finite size of the support (defined by the maximum diameter, $Dmax$).    
FreeSAS proposes an IFT based on the Bayesian statistics and derived from BIFT\cite{bift}, like the one found in \cite{BioXTAS-RAW}.
The command-line programme to perfrom and IFT is \textit{bift.py}. 
Despite our approaches differ, the results of bift.py is similar to the DATGNOM\cite{ATSAS1} from ATSAS which uses a Tikhonov's regularization.

\subsubsection{Equivalence of scattering curves}

\subsubsection{Overlay of bead models}


\subsection{The workflow manager, \textit{Dahu}}

\subsubsection{Online processing}

\subsubsection{Offline processing}
Dahu provides a command-line tool, called \textit{dahu-reprocess} designed to 
(re-)execute one or several pipelines. 
This tool is also used during    



Text text text text text text text text text text text text text text
text text text text text text text.

\section{Data analysis piplines}
\subsection{Integration pipeline}
\subsection{Sample-changer pipeline}
\subsection{SEC-SAXS pipeline}

     % Appendices appear after the main body of the text. They are prefixed by
     % a single \appendix declaration, and are then structured just like the
     % body text.

\appendix
\section{Appendix title}

Text text text text text text text text text text text text text text
text text text text text text text.

\subsection{Title}

Text text text text text text text text text text text text text text
text text text text text text text.

\subsubsection{Title}

Text text text text text text text text text text text text text text
text text text text text text text.


     %-------------------------------------------------------------------------
     % The back matter of the paper - acknowledgements and references
     %-------------------------------------------------------------------------

     % Acknowledgements come after the appendices

\ack{Acknowledgements}

     % References are at the end of the document, between \begin{references}
     % and \end{references} tags. Each reference is in a \reference entry.

\begin{references}
\reference{Author, A. \& Author, B. (1984). \emph{Journal} \textbf{Vol}, 
first page--last page.}
\end{references}

     %-------------------------------------------------------------------------
     % TABLES AND FIGURES SHOULD BE INSERTED AFTER THE MAIN BODY OF THE TEXT
     %-------------------------------------------------------------------------

     % Simple tables should use the tabular environment according to this
     % model

\begin{table}
\caption{Caption to table}
\begin{tabular}{llcr}      % Alignment for each cell: l=left, c=center, r=right
 HEADING    & FOR        & EACH       & COLUMN     \\
\hline
 entry      & entry      & entry      & entry      \\
 entry      & entry      & entry      & entry      \\
 entry      & entry      & entry      & entry      \\
\end{tabular}
\end{table}

     % Postscript figures can be included with multiple figure blocks

\begin{figure}
\caption{Caption describing figure.}
\includegraphics{fig1.ps}
\end{figure}

\bibliographystyle{iucr}
\bibliography{biblio}


\end{document}                    % DO NOT DELETE THIS LINE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
